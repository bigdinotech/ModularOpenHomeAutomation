<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var headerValue = 170;
		var isFahrenheit = 0;
	</script>
	<script>
		 var socket = io.connect();
		 socket.on('server-event-info', function (data) {
			console.log(data);
			 
			var mID = data.charCodeAt(1);
			var dataLength = data.charCodeAt(2);
			var tRadio = document.getElementsByName("tempRadio");
			for (var i = 0, length = tRadio.length; i < length; i++) 
			{
				if(tRadio[i].checked)
				{
					isFahrenheit = i;
					console.log("radio selection: " + i);
					break;
				}
			}
			var tempUnit = "C";
			if(isFahrenheit)
			{
				tempUnit = "F";
			}
			switch(mID)
			{
			case 10:
				//thermostat
				console.log("thermostat module");
				var temp = data.charCodeAt(3);
				var humidity = data.charCodeAt(4);
				var mode = data.charCodeAt(5);
				var targetTemp = data.charCodeAt(6);
				if(isFahrenheit)
				{
					temp = celsiusToFahrenheit(temp);
					targetTemp = celsiusToFahrenheit(targetTemp);
				}
				var displayTemp = document.getElementById('thermostattemperature');
				displayTemp.value = temp + tempUnit;
				var displayHumidity = document.getElementById('thermostathumidity');
				displayHumidity.value = humidity + "%";
				var displayMode = document.getElementById('thermostatmode');
				var displayTargetTemperature = document.getElementById('targetthermostattemperature');
				displayTargetTemperature.value = targetTemp + tempUnit;
				switch(mode)
				{
					case 0:
						displayMode.value = "Off";
						break;
					case 1:
						displayMode.value = "Cool";
						break;
					case 2:
						displayMode.value = "Heat";
						break;
					case 3:
						displayMode.value = "Auto";
						break;
					case 4:
						displayMode.value = "UNK";
						break;
					default:
						break;
				}
				break;
			case 23:
				//garage module
				console.log("garage module");
				var temp = data.charCodeAt(3);
				var humidity = data.charCodeAt(4);
				var gdoorstate = data.charCodeAt(5);
				if(isFahrenheit)
				{
					temp = celsiusToFahrenheit(temp);
				}
				var displayTemp = document.getElementById('garagetemperature');
				displayTemp.value = temp + tempUnit;
				var displayHumidity = document.getElementById('garagehumidity');
				displayHumidity.value = humidity + "%";
				var displayStatus = document.getElementById('garagedoor');
				if(gdoorstate == 1)
				{
					displayStatus.value = "closed";
				}
				else
				{
					displayStatus.value = "open";
				}
				break;
			case 24:
				console.log("outdoor module");
				var temp = data.charCodeAt(3);
				var humidity = data.charCodeAt(4);
				var pirState = data.charCodeAt(5);
				if(isFahrenheit)
				{
					temp = celsiusToFahrenheit(temp);
				}
				var displayTemp = document.getElementById('outdoortemperature');
				displayTemp.value = temp + tempUnit;
				var displayHumidity = document.getElementById('outdoorhumidity');
				displayHumidity.value = humidity + "%";
				var displayStatus = document.getElementById('outdoorPresence');
				if(pirState == 1)
				{
					displayStatus.value = "Presence detected";
				}
				else
				{
					displayStatus.value = "Nothing Detected";
				}
			default:
				break;
			}
		 });
	</script>
	<script>
		function garageDoorButton()
		{
			//socket.emit("command", "tgdoor*");
			var cmdPacket = [];
			var cmdPacketString = "";
			var cmdChecksum = 0;
			var modID = 23;
			cmdChecksum += (modID & 0xFF);
			var cmdLength = 1;
			cmdChecksum += (cmdLength & 0xFF);
			var command = 'g';
			cmdChecksum += (command.charCodeAt(0) & 0xFF);
			
			cmdPacket[0] = (headerValue & 0xFF);
			cmdPacket[1] = (modID & 0xFF);
			cmdPacket[2] = (cmdLength & 0xFF);
			cmdPacket[3] = (command.charCodeAt(0) & 0xFF);
			cmdPacket[cmdLength+3] = (cmdChecksum & 0xFF)
			
			for(i = 0; i < cmdPacket.length; i++)
			{
				cmdPacketString +=  cmdPacket[i] + " ";		
			}
			
			cmdPacketString = cmdPacketString.trim();
			sendData(cmdPacketString);
			console.log(cmdPacketString);
		}

		function garageLightButton()
		{
			//socket.emit("command", "tglight*");
			var cmdPacket = [];
			var cmdPacketString = "";
			var cmdChecksum = 0;
			var modID = 23;
			cmdChecksum += (modID & 0xFF);
			var cmdLength = 1;
			cmdChecksum += (cmdLength & 0xFF);
			var command = 'l';
			cmdChecksum += (command.charCodeAt(0) & 0xFF);
			
			cmdPacket[0] = (headerValue & 0xFF);
			cmdPacket[1] = (modID & 0xFF);
			cmdPacket[2] = (cmdLength & 0xFF);
			cmdPacket[3] = (command.charCodeAt(0) & 0xFF);
			cmdPacket[cmdLength+3] = (cmdChecksum & 0xFF)
			
			for(i = 0; i < cmdPacket.length; i++)
			{
				cmdPacketString +=  cmdPacket[i] + " ";		
			}
			
			cmdPacketString = cmdPacketString.trim();
			sendData(cmdPacketString);
			console.log(cmdPacketString);
		}
		
		function sendData(packet)
		{
			packet += "*";
			socket.emit("command", packet);
		}
		
		function celsiusToFahrenheit(cTemp)
		{
			return Math.round((cTemp*9.0/5.0) + 32);
		}
		
		function thermostatOffButton()
		{
			var mode = 0;
			termostatCommand(mode);
		}
		
		function thermostatCoolButton()
		{
			var mode = 1;
			termostatCommand(mode);
		}
		
		function thermostatHeatButton()
		{
			var mode = 2;
			termostatCommand(mode);
		}
		
		function thermostatAutoButton()
		{
			var mode = 3;
			termostatCommand(mode);
		}
		
		function termostatCommand(mode)
		{
			var cmdPacket = [];
			var cmdPacketString = "";
			var cmdChecksum = 0;
			var modID = 10;
			cmdChecksum += (modID & 0xFF);
			var cmdLength = 3;
			if(mode == 3)
			{
				cmdLength = 4;
			}
			cmdChecksum += (cmdLength & 0xFF);
			var thermostatCommand = 'c';
			if(isFahrenheit)
			{
				thermostatCommand = 'f';
			}
			cmdChecksum += (thermostatCommand.charCodeAt(0) & 0xFF);
			//var mode = 1;
			cmdChecksum += (mode & 0xFF);
			var targetTemp = parseInt(document.getElementById('changetargetthermostattemperature').value);
			var targetTemp2 = parseInt(document.getElementById('changetargetthermostattemperature2').value);
			cmdChecksum += (targetTemp & 0XFF);
			if(mode == 3)
			{
				cmdChecksum += (targetTemp2 & 0XFF);
			}
			cmdPacket[0] = (headerValue & 0xFF);
			cmdPacket[1] = (modID & 0xFF);
			cmdPacket[2] = (cmdLength & 0xFF);
			cmdPacket[3] = (thermostatCommand.charCodeAt(0) & 0xFF);
			cmdPacket[4] = (mode & 0xFF);
			cmdPacket[5] = (targetTemp & 0XFF);
			if(mode == 3)
			{
				cmdPacket[6] = (targetTemp2 & 0XFF);
			}
			cmdPacket[cmdLength+3] = (cmdChecksum & 0xFF);
			for(i = 0; i < cmdPacket.length; i++)
			{
				cmdPacketString +=  cmdPacket[i] + " ";
				//cmdPacketString +=  String.fromCharCode(cmdPacket[i]);
				//console.log((String.fromCharCode(cmdPacket[i])).charCodeAt(0));
				
			}
			cmdPacketString = cmdPacketString.trim();
			sendData(cmdPacketString);
			console.log(cmdPacketString);
			//sendData(cmdPacket);
		}
	</script>
</head>
<body bgcolor="#82CAFA">
	<form method="post" name="banner" target="_self">
			<h1>
					Intel Edison - Home Automation 
					<img class="img" src="galileo.jpg">
					</h1>
			<h3>
	</form>
	<table>
		<tr>
			<td>
				<form method="post" name="GarageForm" target="_self">
					<p>
						Garage Temperature:&nbsp;<textarea class="tempsensor" id="garagetemperature" cols="1" maxlength="10" name="garagetemperature" readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
						<canvas id="garageTempChart" width="400" height="50"></canvas>
					</p>
					<p>
						Garage Humidity:&nbsp;<textarea class="humiditysensor" id="garagehumidity" cols="1" maxlength="10" name="garagehumiditysensor" readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
					</p>
					<p>	
						Garage door state:&nbsp;<textarea class="garagedoor" id="garagedoor" cols="1" maxlength="10" name="garagedoor" readonly="readonly" style="margin: 2px; width: 90px; height: 20px;"></textarea>
					</p>
					<p>
					<input id = "toggleGarageDoor" type = "button" value = "Toggle Garage Door" />
					<input id = "toggleGarageLight" type = "button" value = "Toggle Garage Light" />
				</form>
			</td>
			<td>
				<form method="post" name="OutdoorForm" target="_self">
					<p>
						Outdoor Temperature:&nbsp;<textarea class="tempsensor" id="outdoortemperature" cols="1" maxlength="10" name="outdoortempsensor" readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
					</p>
					<p>
						Outdoor Humidity:&nbsp;<textarea class="humiditysensor" id="outdoorhumidity" cols="1" maxlength="10" name="outdoorhumiditysensor" readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
					</p>
					<p>	
						Outdoor presence state:&nbsp;<textarea class="proximitysensor" id="outdoorPresence" cols="1" maxlength="10" name="outdoorPresence" readonly="readonly" style="margin: 2px; width: 150px; height: 20px;"></textarea>
					</p>
					<p>		
				</form>
			</td>
		</tr>
		<tr>
			<td>
				<form method="post" name="ThermostatForm" target="_self">
	
					<p>
						Thermostat Temperature:&nbsp;<textarea class="tempsensor" id="thermostattemperature" cols="1" maxlength="10" name="thermostattempsensor" readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
					</p>
					<p>
						Thermostat Humidity:&nbsp;<textarea class="humiditysensor" id="thermostathumidity" cols="1" maxlength="10" name="thermostathumiditysensor" readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
					</p>
					<p>
						Thermostat Mode:&nbsp;<textarea class="mode" id="thermostatmode" cols="1" maxlength="10" name="thermostatmode" readonly="readonly" style="margin: 2px; width: 75px; height: 20px;"></textarea>
					</p>
					<p>
						Target Temperature:&nbsp;<textarea class="tempsensor" id="targetthermostattemperature" cols="1" maxlength="10" name="targetthermostattemperature"  readonly="readonly" style="margin: 2px; width: 40px; height: 20px;"></textarea>
					</p>
					
					<p>Mode Select:
						Temp1: <textarea class="tempsensor" id="changetargetthermostattemperature" cols="1" maxlength="10" name="changetargetthermostattemperature"  style="margin: 2px; width: 40px; height: 20px;"></textarea>
						Temp2: <textarea class="tempsensor" id="changetargetthermostattemperature2" cols="1" maxlength="10" name="changetargetthermostattemperature2"  style="margin: 2px; width: 40px; height: 20px;"></textarea>
						<input id = "thermostatOffModeButton" type = "button" value = "Off" />
						<input id = "thermostatCoolModeButton" type = "button" value = "Cool" />
						<input id = "thermostatHeatModeButton" type = "button" value = "Heat" />
						<input id = "thermostatAutoModeButton" type = "button" value = "Auto" />
					</p>
				</form>
			</td>
			<td>
			</td>
		</tr>
		<tr>
			<form action="">
				<input type="radio" name="tempRadio" value="celsius">Celsius<br>
				<input type="radio" name="tempRadio" value="fahrenheit">Fahrenheit
			</form>
		</tr>
	</table>

	<script>
		document.getElementById("toggleGarageDoor").onclick =  garageDoorButton;
		document.getElementById("toggleGarageLight").onclick =  garageLightButton;
		document.getElementById("thermostatOffModeButton").onclick =  thermostatOffButton;
		document.getElementById("thermostatCoolModeButton").onclick =  thermostatCoolButton;
		document.getElementById("thermostatHeatModeButton").onclick =  thermostatHeatButton;
		document.getElementById("thermostatAutoModeButton").onclick =  thermostatAutoButton;
	</script>

	
</body>

</html>

